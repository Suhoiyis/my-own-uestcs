# 1. DMA方式基本概念

### 1. 核心定义 (Definition)

- **全称**：直接存储器访问 (Direct Memory Access)。
    
- **含义**：依靠硬件（DMA 控制器），直接在**主存**与**外围设备**之间进行**简单、批量、快速**的数据传送，传送过程中**不需要 CPU 的干预**。
    
    - _比喻_：CPU 是 CEO，平时亲自处理文件（程序查询），或者等秘书送文件（中断）。现在工作量大了，CEO 直接授权给搬运工（DMA 控制器），说：“你自己把这堆文件搬到仓库去，搬完了再告诉我。”
        

### 2. 实质与特点 (Essence & Characteristics)

#### **(1) 实质：程序暂停 (Program Pause)**

与中断（程序切换）不同，DMA 只是让 CPU **暂停**一下总线的使用权。

- **时间**：在**一条指令执行过程中**的某个存取周期结束时暂停（不必等指令结束）。
    
- **方法**：CPU 让出总线控制权，DMA 接管。
    
- **现场**：**不需要保护断点和现场**！因为 CPU 内部寄存器的状态没变，只是外部总线被借走了。
    

#### **(2) 特点：随机性**

DMA 请求的产生也是随机的，取决于外设什么时候准备好数据。

### 3. 应用场景 (Applications)

DMA 主要用于**高速、批量**的数据传送，因为如果用中断来传高速数据，CPU 会被频繁打断，效率太低。

- **典型设备**：磁盘、磁带、光盘、显卡、网卡。
    
- **典型操作**：DRAM 的刷新、磁盘读写。
    

### 4. DMA 与中断的关系 (DMA vs Interrupt) —— **⭐ 核心考点**

DMA **不能完全取代** 中断。它们通常结合使用：

- **分工**：
    
    - **DMA**：负责最累的体力活 —— **数据传送**（搬运数据）。
        
    - **中断**：负责脑力活 —— **善后处理**（如判断传送是否结束、是否有错、下一步做什么）。
        
- **流程**：`CPU 启动 DMA` $\rightarrow$ `DMA 搬运数据` $\rightarrow$ `搬完发中断` $\rightarrow$ `CPU 响应中断做善后`。
    

---
### 🧠 总结

|**比较维度**|**中断方式**|**DMA 方式**|
|---|---|---|
|**数据传送者**|CPU (软件指令)|DMA 控制器 (硬件)|
|**CPU 状态**|程序切换 (保护现场)|**程序暂停** (不保护现场)|
|**响应时机**|指令结束时|**存取周期结束时**|
|**效率**|低 (适合低速/控制)|**高** (适合高速/批量)|
|**主要用途**|键盘、鼠标、打印机|**磁盘**、显卡|


# 2. DMA控制器与接口的连接

### 1. 硬件连接结构 (Hardware Topology)

请看 **PPT P7** 的连接图，这是理解 DMA 工作模式的关键
![[Pasted image 20251229201433.png]]
- **系统总线上的“双重身份”**：
    
    - **作为从设备 (Slave)**：在初始化阶段，CPU 把 DMA 控制器当成一个普通的 I/O 接口，向它写入控制字（比如“要把数据搬到内存哪里”）。
        
    - **作为主设备 (Master)**：在传送阶段，DMA 控制器接管总线，像 CPU 一样向内存发地址和读写命令 。
        
- **与接口的连接**：
    
    - DMA 控制器并不直接连外设，而是连着 **I/O 接口板**。
        
    - 接口板负责设备的具体细节（准备数据），准备好了就向 DMA 发请求。
        

### 2. 详细的功能分工 (Division of Labor)

课件 P8 清晰地划分了 **DMA 控制器** 和 **I/O 接口** 各自的职责，这是一场接力赛：
![[Pasted image 20251229201508.png]]
#### **A. DMA 控制器 (The Manager) —— 负责“搬运”**

它只关心数据在**总线**和**内存**上的流动，不关心设备具体是啥。

1. **初始化 (Initialization)**：接收 CPU 发来的“搬运工单”：
    
    - **传送方向**（读还是写？）。
        
    - **主存首址**（搬到哪里去？）。
        
    - **交换量**（搬多少个字？）。
        
2. **判优与申请 (Arbitration & Request)**：收到接口发来的请求后，判断优先级，然后向 CPU 申请总线使用权（"Bus Request"）。
    
3. **总线接管 (Bus Control)**：CPU 批准后，DMA 接管总线，发出内存地址和读/写命令，指挥数据流动 。
    

#### **B. I/O 接口 (The Worker) —— 负责“生产/接收”**

它只关心**外设**的状态。

1. **初始化**：接收 CPU 的外设寻址信息（如磁盘的磁道号、扇区号）。
    
2. **发请求**：
    
    - **输入时**：当数据缓冲器满（凑够一个字）了，向 DMA 发请求：“货好了，来搬！”
        
    - **输出时**：当数据缓冲器空了，向 DMA 发请求：“没货了，再运点来！”。
        

---

### 3. 多路 DMA 控制器 (Multi-channel DMA)

课件 P7 还提到了**多路型 DMA 控制器**的概念。一个 DMA 控制器可以同时管理多个设备（比如同时有磁盘和显卡在工作）。

- **工作方式**：
    
    - **交叉传送**：大家轮流用（以字节为单位）。
        
    - **成组传送**：一个传完一大块，另一个再传 。
        

---

### 🧠 总结

- **接口** 负责盯着设备，数据好了就喊 DMA。
    
- **DMA** 负责盯着总线和内存，听到喊声就去向 CPU 请假（申请总线），批准后直接把数据在接口和内存之间“瞬移”。


# 3. 磁盘存储器接口


以**硬盘适配器**为例，展示了一个复杂的、智能化的 DMA 接口是如何工作的。

这不仅仅是一个简单的开关门接口，它实际上是一个**“带有独立大脑的小型计算机系统”**。

---

### 一、硬件架构：三级连接与“双重 DMA”

#### 1. 系统连接方式 (System Connection)

请看 **PPT P9** 的架构图。硬盘适配器（接口卡）夹在**系统总线**和**硬盘驱动器**之间 1。

#### 2. “双重 DMA” 概念 (Two-level DMA) —— **⭐ 关键点**

为了保证速度匹配，数据传输被分成了两段，由两个不同的控制器负责：

1. **适配器内部 DMA**：负责 **驱动器 $\leftrightarrow$ 适配器内部缓存 (RAM)** 之间的数据传送。
    
    - _特点_：处理串行数据，速度极快。
        
2. **主机板上 DMA**：负责 **适配器内部缓存 $\leftrightarrow$ 主存储器 (Memory)** 之间的数据传送。
    
    - _特点_：处理并行数据，占用系统总线。
        

---

### 二、适配器的内部“三巨头” (Internal Components)

课件 P10-P11 将适配器内部划分为三个逻辑模块，功能分工非常明确：

#### **1. 处理机接口 (Processor Interface) —— “对外公关部”**

- **面向**：系统总线（CPU）。
    
- **功能**：
    
    - **I/O 端口逻辑**：接收 CPU 发来的读写命令和参数（如“读第几号扇区”）。
        
    - **EPROM**：存放硬盘的驱动程序（BIOS 启动时会用到）。
        

#### **2. 智能主控器 (Intelligent Master) —— “中央指挥部”**

- **核心**：**微处理器 (Microprocessor)**。它有自己的大脑，执行固化在 ROM 里的控制程序 3。
    
- **缓存**：**RAM (扇区缓存)**。这是数据歇脚的中转站，通常能存 1-2 个扇区的数据。
    

#### **3. 驱动器接口 (Drive Interface) —— “一线车间”**

- **面向**：硬盘驱动器。
    
- **功能**：
    
    - **串/并转换**：硬盘读写的是**串行**磁信号，而总线传的是**并行**信号。这里必须进行转换 4。
        
    - **内部 DMA 控制**：控制数据在驱动器和 RAM 缓存之间流动。
        
    - **控制逻辑**：发具体的硬件指令（如“磁头移动”、“选通磁头”）。
        

---

### 三、硬盘调用全过程 (Disk Call Process) —— **⭐ 必考综合流程**

这是一个完美的 **CPU + DMA + 中断** 协同工作的例子。请务必背诵 **P12** 的六步流程：

#### **第一阶段：预处理 (由 CPU 主导)**

1. **CPU 初始化**：
    
    - 向 **适配器** 发送命令：你要读哪张盘、哪个柱面（磁道）、哪个磁头、哪个扇区？
        
    - 向 **主机 DMA 控制器** 发送命令：内存首地址在哪里？要传多少数据？是读还是写？
        

#### **第二阶段：寻道与准备 (由适配器主导)**

2. **寻道** 5：
    
    - 适配器控制硬盘进行机械动作（寻道）。
        
    - 如果寻道错误，发中断报错；如果正确，启动读/写。
        
3. **数据装填**：
    
    - **读盘时**：驱动器把数据读入适配器的 RAM，直到**填满一个扇区**。
        
    - **写盘时**：等待 RAM 空出一个扇区的位置。
        
    - 此时，适配器向主机 DMA 发出 **DMA 请求**。
        

#### **第三阶段：数据传送 (由 DMA 主导)**

4. **传送**：
    
    - 主机 DMA 控制器接管总线。
        
    - 数据像流水一样在 **适配器 RAM** 和 **主存** 之间高速传输。
        
    - _注意_：这个过程 CPU 是靠边站的。
        

#### **第四阶段：善后 (由中断主导)**

5. **申请中断**：
    
    - 批量数据（如一个扇区）传完了，DMA 任务结束，适配器向 CPU 发 **中断请求**。
        
6. **CPU 响应**：
    
    - CPU 暂停当前工作，检查传输状态（成功了吗？校验对吗？），决定是结束还是读下一个扇区。
