# -------------------------------------------------------------------
# 纯汇编版: UART 接收 -> 数码管显示
# 对应 C 文件: rx_and_print.c
# -------------------------------------------------------------------

# ===================================================================
# 寄存器规划
# s0: UART 基地址 (0x30000000)
# s1: 数码管 基地址 (0x40000000)
# s2: 临时保存接收到的第1个数 (num1)
# s3: 临时保存接收到的第2个数 (num2)
# s4: 常数 10 (用于十进制分离)
# s5: 常数 100 (用于分离百位)
# ===================================================================

start_kernel:
    # --- 1. 初始化基地址 ---
    lui     s0, 0x30000         # UART Base = 0x30000000
    lui     s1, 0x40000         # SEG Base  = 0x40000000

    # --- 2. 加载常数 ---
    addi    s4, zero, 10        # s4 = 10
    addi    s5, zero, 100       # s5 = 100

    # --- 3. 初始化 UART (Ctrl=3) ---
    addi    t0, zero, 3
    sw      t0, 0(s0)           # 写入 UART_CTRL

    # --- 4. 初始清屏 (SEG 1-6 写 0) ---
    sb      zero, 1(s1)
    sb      zero, 2(s1)
    sb      zero, 3(s1)
    sb      zero, 4(s1)
    sb      zero, 5(s1)
    sb      zero, 6(s1)

main_loop:
    # ===============================================================
    # 步骤 A: 接收数据
    # ===============================================================

    # 接收 num1
    jal     ra, uart_rx         # 调用接收子程序
    add     s2, a0, zero        # s2 = num1

    # 接收 num2
    jal     ra, uart_rx         # 调用接收子程序
    add     s3, a0, zero        # s3 = num2

    # ===============================================================
    # 步骤 B: 显示 num1 (左边 SEG 1,2,3)
    # ===============================================================

    # --- 百位: (num1 / 100) % 10 ---
    divu    t0, s2, s5          # t0 = num1 / 100
    remu    t0, t0, s4          # t0 = t0 % 10
    sb      t0, 1(s1)           # 写入 SEG_1

    # --- 十位: (num1 / 10) % 10 ---
    divu    t0, s2, s4          # t0 = num1 / 10
    remu    t0, t0, s4          # t0 = t0 % 10
    sb      t0, 2(s1)           # 写入 SEG_2

    # --- 个位: num1 % 10 ---
    remu    t0, s2, s4          # t0 = num1 % 10
    sb      t0, 3(s1)           # 写入 SEG_3

    # ===============================================================
    # 步骤 C: 显示 num2 (右边 SEG 4,5,6)
    # ===============================================================

    # --- 百位 ---
    divu    t0, s3, s5
    remu    t0, t0, s4
    sb      t0, 4(s1)           # 写入 SEG_4

    # --- 十位 ---
    divu    t0, s3, s4
    remu    t0, t0, s4
    sb      t0, 5(s1)           # 写入 SEG_5

    # --- 个位 ---
    remu    t0, s3, s4
    sb      t0, 6(s1)           # 写入 SEG_6

    # 循环回去
    jal     zero, main_loop


# ===================================================================
# 子程序: uart_rx
# 功能: 阻塞等待并读取一个字
# 返回: a0 = 接收到的数据
# ===================================================================
uart_rx:
    # 1. 读取状态寄存器 (偏移 4)
    lw      t0, 4(s0)

    # 2. 检查第1位 (RX_DONE)
    andi    t0, t0, 2           # t0 = t0 & 2

    # 3. 如果为0，继续等待
    beq     t0, zero, uart_rx

    # 4. 读取数据 (偏移 16)
    lw      a0, 16(s0)

    # 5. 清除状态位 (偏移 4)
    sw      zero, 4(s0)

    # 6. 返回
    jalr    zero,  ra, 0